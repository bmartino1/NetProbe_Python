# docker-compose.yml
#version: "3.8"

services:
  postgres:
    image: postgres:16-alpine
    container_name: netprobe-postgres
    restart: unless-stopped
    # If you want to keep config in a file:
    #env_file:
    #  - ./probe/config.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-netprobe}
      POSTGRES_USER: ${POSTGRES_USER:-netprobe}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-netprobe}
    volumes:
      - netprobe_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-netprobe} -d ${POSTGRES_DB:-netprobe}"]
      interval: 10s
      timeout: 5s
      retries: 5

  netprobe:
    build: ./probe
    # Image exist..., you gitclone the project and build run the image instead:
    # image: bmmbmm01/netprobe:latest
    container_name: netprobe
    restart: unless-stopped

    # If you want to keep config in a file:
    # env_file:
    #   - ./probe/config.env

    depends_on:
      - postgres

    environment:
      # ---- Core app settings ----
      WEB_PORT: ${WEB_PORT:-8080}

      # SQLite path (still used if DB_ENGINE=sqlite)
      DB_PATH: ${DB_PATH:-/data/netprobe.sqlite}

      # Database backend:
      #   postgres -> use the postgres service below
      #   sqlite   -> use DB_PATH file
      DB_ENGINE: ${DB_ENGINE:-postgres}
      # Or alternatively, leave DB_ENGINE unset and use:
      # USE_POSTGRES: ${USE_POSTGRES:-true}

      # Postgres connection details (match the postgres service)
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-netprobe}
      POSTGRES_USER: ${POSTGRES_USER:-netprobe}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-netprobe}

      PROBE_INTERVAL: ${PROBE_INTERVAL:-30}
      PING_COUNT: ${PING_COUNT:-4}
      APP_TIMEZONE: ${APP_TIMEZONE:-UTC}

      # Ping targets
      SITES: ${SITES:-fast.com,google.com,youtube.com}
      ROUTER_IP: ${ROUTER_IP:-}

      # DNS config
      DNS_TEST_SITE: ${DNS_TEST_SITE:-google.com}

      DNS_NAMESERVER_1: ${DNS_NAMESERVER_1:-Google_DNS}
      DNS_NAMESERVER_1_IP: ${DNS_NAMESERVER_1_IP:-8.8.8.8}
      DNS_NAMESERVER_2: ${DNS_NAMESERVER_2:-Quad9_DNS}
      DNS_NAMESERVER_2_IP: ${DNS_NAMESERVER_2_IP:-9.9.9.9}
      DNS_NAMESERVER_3: ${DNS_NAMESERVER_3:-CloudFlare_DNS}
      DNS_NAMESERVER_3_IP: ${DNS_NAMESERVER_3_IP:-1.1.1.1}
      DNS_NAMESERVER_4: ${DNS_NAMESERVER_4:-My_DNS_Server}
      DNS_NAMESERVER_4_IP: ${DNS_NAMESERVER_4_IP:-192.168.1.1}

      # Health Score Weights (should sum to 1.0)
      WEIGHT_LOSS: ${WEIGHT_LOSS:-0.6}
      WEIGHT_LATENCY: ${WEIGHT_LATENCY:-0.15}
      WEIGHT_JITTER: ${WEIGHT_JITTER:-0.2}
      WEIGHT_DNS_LATENCY: ${WEIGHT_DNS_LATENCY:-0.05}

      # Health Score Thresholds
      THRESHOLD_LOSS: ${THRESHOLD_LOSS:-5}
      THRESHOLD_LATENCY: ${THRESHOLD_LATENCY:-100}
      THRESHOLD_JITTER: ${THRESHOLD_JITTER:-30}
      THRESHOLD_DNS_LATENCY: ${THRESHOLD_DNS_LATENCY:-100}

      # Speedtest configuration
      SPEEDTEST_ENABLED: ${SPEEDTEST_ENABLED:-True}
      SPEEDTEST_INTERVAL: ${SPEEDTEST_INTERVAL:-14400}

    ports:
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"

    volumes:
      - netprobe_data:/data

    # Optional: if you need extra network capabilities for ping, etc.
    #cap_add:
    #  - NET_RAW
    #  - NET_ADMIN
    #  - SYS_ADMIN

    # Optional: use an existing host network on Unraid (e.g. br0)
    #networks:
    #  default:
    #    external: true
    #    name: br0

volumes:
  netprobe_data:
      # Unraid Optional Bind Mount Volume to folder...
     #driver: local
     #driver_opts:
     #  type: none
     #  device: /mnt/user/appdata/netprobe/sqlite
     #  o: bind
  netprobe_pgdata:
    # Unraid Optional Bind Mount Volume to folder...
     #driver: local
     #driver_opts:
     #  type: none
     #  device: /mnt/user/appdata/netprobe/postgres
     #  o: bind
