# docker-compose.yml
#version: "3.8"

services:
  netprobe:
    build: ./probe
    # When you push to Docker Hub, you can use the prebuilt image instead:
    # image: bmmbmm01/netprobe:latest
    container_name: netprobe
    restart: unless-stopped

    # If you want to keep config in a file:
    # env_file:
    #   - ./probe/config.env

    environment:
      # ---- Core app settings ----
      WEB_PORT: ${WEB_PORT:-8080}
      DB_PATH: ${DB_PATH:-/data/netprobe.sqlite}
      PROBE_INTERVAL: ${PROBE_INTERVAL:-30}
      PING_COUNT: ${PING_COUNT:-5}
      APP_TIMEZONE: ${APP_TIMEZONE:-UTC}

      # Ping targets
      SITES: ${SITES:-fast.com,google.com,youtube.com}
      ROUTER_IP: ${ROUTER_IP:-}

      # DNS config
      DNS_TEST_SITE: ${DNS_TEST_SITE:-google.com}

      DNS_NAMESERVER_1: ${DNS_NAMESERVER_1:-Google_DNS}
      DNS_NAMESERVER_1_IP: ${DNS_NAMESERVER_1_IP:-8.8.8.8}
      DNS_NAMESERVER_2: ${DNS_NAMESERVER_2:-Quad9_DNS}
      DNS_NAMESERVER_2_IP: ${DNS_NAMESERVER_2_IP:-9.9.9.9}
      DNS_NAMESERVER_3: ${DNS_NAMESERVER_3:-CloudFlare_DNS}
      DNS_NAMESERVER_3_IP: ${DNS_NAMESERVER_3_IP:-1.1.1.1}
      DNS_NAMESERVER_4: ${DNS_NAMESERVER_4:-My_DNS_Server}
      DNS_NAMESERVER_4_IP: ${DNS_NAMESERVER_4_IP:-192.168.1.1}

      # Health Score Weights (should sum to 1.0)
      WEIGHT_LOSS: ${WEIGHT_LOSS:-0.6}
      WEIGHT_LATENCY: ${WEIGHT_LATENCY:-0.15}
      WEIGHT_JITTER: ${WEIGHT_JITTER:-0.2}
      WEIGHT_DNS_LATENCY: ${WEIGHT_DNS_LATENCY:-0.05}

      # Health Score Thresholds
      THRESHOLD_LOSS: ${THRESHOLD_LOSS:-5}
      THRESHOLD_LATENCY: ${THRESHOLD_LATENCY:-100}
      THRESHOLD_JITTER: ${THRESHOLD_JITTER:-30}
      THRESHOLD_DNS_LATENCY: ${THRESHOLD_DNS_LATENCY:-100}

      # Speedtest configuration
      SPEEDTEST_ENABLED: ${SPEEDTEST_ENABLED:-True}
      SPEEDTEST_INTERVAL: ${SPEEDTEST_INTERVAL:-14400}

    ports:
      - "${WEB_PORT:-8080}:${WEB_PORT:-8080}"

    volumes:
      - netprobe_data:/data

    # Optional: if you need extra network capabilities for ping, etc.
    #cap_add:
    #  - NET_RAW
    #  - NET_ADMIN
    #  - SYS_ADMIN

    # Optional: use an existing host network on Unraid (e.g. br0)
    #networks:
    #  default:
    #    external: true
    #    name: br0

volumes:
  netprobe_data:
#Unraid Optional Bind Mount Volume to folder...
#    driver: local
#    driver_opts:
#      type: none
#      device: /mnt/user/appdata/netprobe/database
#      o: bind
